<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…</title>
    <!-- æ·»åŠ  Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: #f50057;
            transform: translateY(-2px);
        }
        
        .page-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 120px);
        }
        
        #karaoke-page {
            display: flex;
            width: 100%;
            gap: 20px;
        }
        
        .browse-section {
            flex: 7;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .playlist-section {
            flex: 3;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .search-box button {
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .search-box button:hover {
            background: #f50057;
            transform: translateY(-2px);
        }
        
        .charts-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px;
        }
        
        .chart-category {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
        }
        
        .chart-category:hover, .chart-category.active {
            background: #ff4081;
            transform: translateY(-3px);
        }
        
        .songs-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .song {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .song:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .song-info {
            flex: 1;
        }
        
        .song-title {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .song-artist {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .song-album {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 3px;
        }
        
        .song-controls {
            display: flex;
            gap: 5px;
        }
        
        .add-btn, .preview-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .preview-btn {
            background: #2196f3;
        }
        
        .add-btn:hover {
            background: #388e3c;
            transform: scale(1.1);
        }
        
        .preview-btn:hover {
            background: #0b7dda;
            transform: scale(1.1);
        }
        
        .playlist {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .playlist-items {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .playlist-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            transition: all 0.3s;
        }
        
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .playlist-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .song-number {
            width: 25px;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.8rem;
        }
        
        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .remove-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
        .playlist-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .playlist-controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .clear-btn {
            background: #f44336;
            color: white;
        }
        
        .share-btn {
            background: #2196f3;
            color: white;
        }
        
        .playlist-controls button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .playlist-pagination {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .playlist-pagination button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .playlist-pagination button:hover, .playlist-pagination button.active {
            background: #ff4081;
        }
        
        .empty-playlist {
            text-align: center;
            padding: 30px;
            opacity: 0.7;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            opacity: 0.7;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            background: rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .back-btn {
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }
        
        #pricing-page {
            display: none;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
        }
        
        .pricing-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .pricing-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .pricing-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .pricing-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px;
        }
        
        .pricing-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .pricing-card.popular {
            border: 2px solid #ff4081;
            position: relative;
            transform: scale(1.05);
        }
        
        .popular-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4081;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .plan-name {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .song-range {
            font-size: 1.1rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .price {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffeb3b;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .price small {
            font-size: 1rem;
            color: #fff;
            opacity: 0.8;
        }
        
        .select-btn {
            width: 100%;
            padding: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
            margin-top: auto;
        }
        
        .select-btn:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .shipping-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .shipping-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .shipping-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .shipping-option {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
        }
        
        .region {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .shipping-cost {
            font-size: 1.5rem;
            color: #ffeb3b;
            font-weight: bold;
        }
        
        .delivery-time {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .note {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
            opacity: 0.8;
        }
        
        .contact-info {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .contact-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .contact-details {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        #order-page {
            display: none;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
        }
        
        .order-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .playlist-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .playlist-preview-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .price-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffeb3b;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .cancel-btn, .submit-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        .submit-btn {
            background: #4caf50;
            color: white;
        }
        
        .cancel-btn:hover, .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .audio-player {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .audio-player.hidden {
            display: none;
        }
        
        .audio-info {
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .audio-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .login-btn, .logout-btn {
            padding: 8px 15px;
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .login-btn:hover, .logout-btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #1a2a6c;
        }
        
        .modal input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .modal button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #1a2a6c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .modal button:hover {
            background: #0d1a4a;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .admin-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-controls button {
            padding: 8px 15px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .orders-table th, .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .orders-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        
        .status-pending { color: #ff9800; }
        .status-confirmed { color: #4caf50; }
        .status-completed { color: #2196f3; }
        
        @media (max-width: 1200px) {
            .songs-container {
                grid-template-columns: 1fr;
            }
            
            .pricing-cards {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .page-container {
                flex-direction: column;
                height: auto;
            }
            
            #karaoke-page {
                flex-direction: column;
            }
            
            .pricing-card.popular {
                transform: scale(1);
            }
            
            .shipping-details {
                flex-direction: column;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <button class="close-btn" id="close-login">&times;</button>
            <h2>ç™»å½•/æ³¨å†Œ</h2>
            <p>ä½¿ç”¨é©¬æ¥è¥¿äºšç”µè¯å·ç ç™»å½•</p>
            <input type="tel" id="phone-input" placeholder="+60 12-345 6789" pattern="\+60[0-9]{8,10}">
            <button id="login-submit">ç™»å½•/æ³¨å†Œ</button>
            <p style="font-size: 0.8rem; margin-top: 10px; color: #666;">
                æç¤ºï¼šé©¬æ¥è¥¿äºšç”µè¯å·ç æ ¼å¼ä¸º +60 åæ¥8-10ä½æ•°å­—
            </p>
        </div>
    </div>

    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="logo">ğŸ¤ å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…</div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">ç‚¹æ­Œç³»ç»Ÿ</button>
                <button class="nav-btn" id="pricing-nav">ä»·æ ¼é…å¥—</button>
                <button class="nav-btn" id="admin-nav">è®¢å•ç®¡ç†</button>
            </div>
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <span id="user-phone"></span>
                    <button class="logout-btn" id="logout-btn">é€€å‡º</button>
                </div>
                <button class="login-btn" id="login-btn">ç™»å½•/æ³¨å†Œ</button>
            </div>
        </nav>
        
        <!-- é¡µé¢å®¹å™¨ -->
        <div class="page-container">
            <!-- ç‚¹æ­Œç³»ç»Ÿé¡µé¢ -->
            <div id="karaoke-page">
                <section class="browse-section">
                    <h2 class="section-title">ğŸµ æ­Œæ›²æµè§ˆ</h2>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="æœç´¢æ­Œæ‰‹æˆ–æ­Œæ›²...">
                        <button id="search-btn">æœç´¢</button>
                    </div>
                    <div class="charts-container" id="charts-container">
                        <div class="chart-category active" data-category="chinese-pop">ä¸­æ–‡æµè¡Œ</div>
                        <div class="chart-category" data-category="western-pop">æ¬§ç¾æµè¡Œ</div>
                        <div class="chart-category" data-category="chinese-dj">ä¸­æ–‡DJ Remix</div>
                        <div class="chart-category" data-category="chinese-artists">ä¸­æ–‡æ­Œæ‰‹</div>
                        <div class="chart-category" data-category="western-artists">æ¬§ç¾æ­Œæ‰‹</div>
                    </div>
                    <div class="songs-container" id="songs-container">
                        <div class="empty-playlist">è¯·é€‰æ‹©æ’è¡Œæ¦œæˆ–æœç´¢æ­Œæ›²</div>
                    </div>
                </section>
                
                <section class="playlist-section">
                    <h2 class="section-title">ğŸ“‹ æˆ‘çš„æ­Œå• <span id="playlist-count">(0)</span></h2>
                    <div class="playlist" id="playlist">
                        <div class="playlist-items" id="playlist-items">
                            <div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>
                        </div>
                        <div class="playlist-pagination" id="playlist-pagination"></div>
                    </div>
                    <div class="playlist-controls">
                        <button class="clear-btn" id="clear-btn">æ¸…ç©ºæ­Œå•</button>
                        <button class="share-btn" id="share-btn">æäº¤è®¢å•</button>
                    </div>
                </section>
            </div>
            
            <!-- ä»·æ ¼é…å¥—é¡µé¢ -->
            <div id="pricing-page">
                <div class="pricing-header">
                    <h1 class="pricing-title">ğŸµ ä»·æ ¼é…å¥—</h1>
                    <p class="pricing-subtitle">é€‰æ‹©é€‚åˆæ‚¨çš„æ­Œå•é…å¥—ï¼Œæ‰“é€ ä¸“å±éŸ³ä¹ä½“éªŒ</p>
                </div>
                
                <section class="pricing-section">
                    <h2 class="section-title">é€‰æ‹©æ‚¨çš„é…å¥—</h2>
                    <div class="pricing-cards">
                        <!-- åŸºç¡€ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">åŸºç¡€ç‰ˆ</div>
                            <div class="song-range">1 - 20 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>29</span></div>
                            <button class="select-btn" data-plan="åŸºç¡€ç‰ˆ" data-min="1" data-max="20" data-price="29">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- æ ‡å‡†ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">æ ‡å‡†ç‰ˆ</div>
                            <div class="song-range">21 - 50 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>49</span></div>
                            <button class="select-btn" data-plan="æ ‡å‡†ç‰ˆ" data-min="21" data-max="50" data-price="49">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è¿›é˜¶ç‰ˆ -->
                        <div class="pricing-card popular">
                            <div class="popular-badge">æœ€å—æ¬¢è¿</div>
                            <div class="plan-name">è¿›é˜¶ç‰ˆ</div>
                            <div class="song-range">51 - 100 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>69</span></div>
                            <button class="select-btn" data-plan="è¿›é˜¶ç‰ˆ" data-min="51" data-max="100" data-price="69">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è±ªåç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">è±ªåç‰ˆ</div>
                            <div class="song-range">101 - 200 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>89</span></div>
                            <button class="select-btn" data-plan="è±ªåç‰ˆ" data-min="101" data-max="200" data-price="89">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- ä¸“ä¸šç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">ä¸“ä¸šç‰ˆ</div>
                            <div class="song-range">201 - 300 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>109</span></div>
                            <button class="select-btn" data-plan="ä¸“ä¸šç‰ˆ" data-min="201" data-max="300" data-price="109">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- æ——èˆ°ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">æ——èˆ°ç‰ˆ</div>
                            <div class="song-range">301 - 400 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>129</span></div>
                            <button class="select-btn" data-plan="æ——èˆ°ç‰ˆ" data-min="301" data-max="400" data-price="129">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è‡³å°Šç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">è‡³å°Šç‰ˆ</div>
                            <div class="song-range">401 - 500 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>159</span></div>
                            <button class="select-btn" data-plan="è‡³å°Šç‰ˆ" data-min="401" data-max="500" data-price="159">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è‡ªå®šä¹‰ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">è‡ªå®šä¹‰ç‰ˆ</div>
                            <div class="song-range">501+ é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>0.30</span><small>/æ¯é¦–</small></div>
                            <button class="select-btn" data-plan="è‡ªå®šä¹‰ç‰ˆ" data-min="501" data-max="9999" data-price="0.30">è”ç³»å®šåˆ¶</button>
                        </div>
                    </div>
                </section>
                
                <section class="shipping-info">
                    <h2 class="shipping-title">é…é€ä¿¡æ¯</h2>
                    <div class="shipping-details">
                        <div class="shipping-option">
                            <div class="region">è¥¿é©¬</div>
                            <div class="shipping-cost">å…è´¹é…é€</div>
                            <div class="delivery-time">é¢„è®¡ 5-7 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                        <div class="shipping-option">
                            <div class="region">ä¸œé©¬</div>
                            <div class="shipping-cost">RM 8.00</div>
                            <div class="delivery-time">é¢„è®¡ 7-10 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                    </div>
                    <p class="note">* æ‰€æœ‰é…å¥—å‡åŒ…å«å®Œæ•´çš„æŠ€æœ¯æ”¯æŒå’Œå”®åæœåŠ¡</p>
                </section>
                
                <section class="contact-info">
                    <h2 class="contact-title">éœ€è¦å¸®åŠ©ï¼Ÿ</h2>
                    <p class="contact-details">è”ç³»æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿï¼š</p>
                    <p class="contact-details">ğŸ“ ç”µè¯: +60 12-345 6789</p>
                    <p class="contact-details">âœ‰ï¸ é‚®ç®±: support@karaoke.com</p>
                    <p class="contact-details">ğŸ•’ æœåŠ¡æ—¶é—´: å‘¨ä¸€è‡³å‘¨æ—¥ 9:00 - 18:00</p>
                </section>
            </div>
            
            <!-- è®¢å•é¡µé¢ -->
            <div id="order-page">
                <div class="order-form">
                    <h2 class="section-title">å¡«å†™è®¢å•èµ„æ–™</h2>
                    
                    <div class="form-group">
                        <label for="customer-name">å§“å</label>
                        <input type="text" id="customer-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-phone">ç”µè¯å·ç </label>
                        <input type="tel" id="customer-phone" placeholder="+60 12-345 6789" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-address">æ”¶è´§åœ°å€</label>
                        <input type="text" id="customer-address" placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-state">å·å±</label>
                        <select id="customer-state" required>
                            <option value="">è¯·é€‰æ‹©å·å±</option>
                            <option value="west">è¥¿é©¬</option>
                            <option value="east">ä¸œé©¬</option>
                        </select>
                    </div>
                    
                    <div class="playlist-preview" id="order-playlist-preview">
                        <!-- æ­Œå•é¢„è§ˆå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="price-summary" id="price-summary">
                        <!-- ä»·æ ¼æ‘˜è¦å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="form-buttons">
                        <button class="cancel-btn" id="cancel-order">å–æ¶ˆ</button>
                        <button class="submit-btn" id="submit-order">ç¡®è®¤è®¢å•</button>
                    </div>
                </div>
            </div>
            
            <!-- è®¢å•ç®¡ç†é¡µé¢ -->
            <div id="admin-page" style="display: none; width: 100%; overflow-y: auto; padding: 20px;">
                <div class="pricing-header">
                    <h1 class="pricing-title">ğŸ“Š è®¢å•ç®¡ç†ç³»ç»Ÿ</h1>
                    <p class="pricing-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å®¢æˆ·è®¢å•</p>
                </div>
                
                <section class="admin-section">
                    <h2 class="section-title">è®¢å•åˆ—è¡¨</h2>
                    <div class="admin-controls">
                        <button id="refresh-orders">åˆ·æ–°è®¢å•</button>
                        <button id="export-orders">å¯¼å‡ºè®¢å•</button>
                    </div>
                    <div class="orders-container" id="orders-container">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>è®¢å•ç¼–å·</th>
                                    <th>å®¢æˆ·å§“å</th>
                                    <th>ç”µè¯å·ç </th>
                                    <th>æ­Œæ›²æ•°é‡</th>
                                    <th>é…å¥—</th>
                                    <th>æ€»é‡‘é¢</th>
                                    <th>çŠ¶æ€</th>
                                    <th>ä¸‹å•æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                                <!-- è®¢å•æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <div class="audio-player hidden" id="audio-player">
        <div class="audio-info" id="audio-info">è¯•å¬ä¸­...</div>
        <div class="audio-controls">
            <button id="play-pause-btn">â¸ï¸</button>
            <button id="stop-btn">â¹ï¸</button>
        </div>
    </div>

    <script>
        // ==================== Supabase é…ç½® ====================
        const SUPABASE_URL = 'https://cnatjskljtjqolznoizb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuYXRqc2tsanRqcW9sem5vaXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMDUzMzMsImV4cCI6MjA3ODg4MTMzM30.okHQXFBoLaMyR3wdgP-1W_Z1spqcb-ihC4Xf2gz1MgU';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('users').select('count');
                if (error) throw error;
                console.log('âœ… Supabase è¿æ¥æˆåŠŸ');
                return true;
            } catch (error) {
                console.log('âŒ Supabase è¿æ¥å¤±è´¥:', error.message);
                return false;
            }
        }

        // ==================== é¡µé¢åˆ‡æ¢åŠŸèƒ½ ====================
        document.getElementById('karaoke-nav').addEventListener('click', function() {
            showPage('karaoke');
            setActiveNav(this);
        });
        
        document.getElementById('pricing-nav').addEventListener('click', function() {
            showPage('pricing');
            setActiveNav(this);
        });
        
        document.getElementById('admin-nav').addEventListener('click', function() {
            showPage('admin');
            setActiveNav(this);
            loadOrders();
        });
        
        function showPage(page) {
            document.getElementById('karaoke-page').style.display = page === 'karaoke' ? 'flex' : 'none';
            document.getElementById('pricing-page').style.display = page === 'pricing' ? 'block' : 'none';
            document.getElementById('order-page').style.display = page === 'order' ? 'block' : 'none';
            document.getElementById('admin-page').style.display = page === 'admin' ? 'block' : 'none';
        }
        
        function setActiveNav(activeButton) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        // ==================== ä»·æ ¼é…å¥—åŠŸèƒ½ ====================
        document.querySelectorAll('.select-btn').forEach(button => {
            button.addEventListener('click', function() {
                const planName = this.dataset.plan;
                const minSongs = this.dataset.min;
                const maxSongs = this.dataset.max;
                const price = this.dataset.price;
                
                if (planName === 'è‡ªå®šä¹‰ç‰ˆ') {
                    alert(`æ‚¨é€‰æ‹©äº† ${planName}\nä»·æ ¼: RM${price}/æ¯é¦–\n\nè¯·é€šè¿‡ç”µè¯æˆ–é‚®ç®±è”ç³»æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿè¿›è¡Œå®šåˆ¶ã€‚`);
                } else {
                    alert(`æ‚¨é€‰æ‹©äº† ${planName} é…å¥—\næ­Œæ›²èŒƒå›´: ${minSongs} - ${maxSongs} é¦–\nä»·æ ¼: RM${price}\n\nè¯·å…ˆåˆ›å»ºæ­Œå•ï¼Œç„¶åæäº¤è®¢å•ã€‚`);
                }
            });
        });
        
        // ==================== ç”¨æˆ·ç™»å½•åŠŸèƒ½ ====================
        let currentUser = null;
        const loginModal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn');
        const closeLoginBtn = document.getElementById('close-login');
        const loginSubmitBtn = document.getElementById('login-submit');
        const phoneInput = document.getElementById('phone-input');
        const userInfo = document.getElementById('user-info');
        const userPhone = document.getElementById('user-phone');
        const logoutBtn = document.getElementById('logout-btn');
        
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkUserLogin() {
            const savedUser = localStorage.getItem('currentUser');
            const savedPhone = localStorage.getItem('userPhone');
            
            if (savedUser && savedPhone) {
                currentUser = savedUser;
                updateUserUI();
                loadUserPlaylist();
            }
        }
        
        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserUI() {
            const savedUser = localStorage.getItem('currentUser');
            const savedPhone = localStorage.getItem('userPhone');
            
            if (savedUser && savedPhone) {
                currentUser = savedUser;
                userPhone.textContent = savedPhone;
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
            } else {
                currentUser = null;
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
            }
        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const phone = phoneInput.value.trim();
            
            // ç®€å•çš„é©¬æ¥è¥¿äºšç”µè¯å·ç éªŒè¯
            const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
            
            if (!malaysiaPhoneRegex.test(phone)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
                return;
            }
            
            try {
                showMessage('ç™»å½•ä¸­...');
                
                // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
                const { data: user, error } = await supabase
                    .from('users')
                    .upsert({ 
                        phone: phone,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'phone',
                        ignoreDuplicates: false
                    })
                    .select()
                    .single();
                    
                if (error) {
                    console.error('Supabase é”™è¯¯:', error);
                    throw error;
                }
                
                currentUser = user.id;
                localStorage.setItem('currentUser', currentUser);
                localStorage.setItem('userPhone', phone);
                
                updateUserUI();
                loginModal.style.display = 'none';
                
                // åŠ è½½ç”¨æˆ·çš„æ­Œå•
                await loadUserPlaylist();
                
                showMessage(`æ¬¢è¿å›æ¥ï¼${phone}`);
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showMessage('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // å¤„ç†é€€å‡º
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userPhone');
            updateUserUI();
            
            // æ¸…ç©ºå½“å‰æ­Œå•
            playlist = [];
            renderPlaylist();
            updatePlaylistCount();
            
            showMessage('å·²é€€å‡ºç™»å½•');
        }
        
        // ç™»å½•ç›¸å…³äº‹ä»¶
        loginBtn.addEventListener('click', () => {
            loginModal.style.display = 'flex';
        });
        
        closeLoginBtn.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });
        
        loginSubmitBtn.addEventListener('click', handleLogin);
        
        logoutBtn.addEventListener('click', handleLogout);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
        
        // ==================== ç‚¹æ­Œç³»ç»ŸåŠŸèƒ½ ====================
        // å…¨å±€å˜é‡
        let currentSongs = [];
        let playlist = [];
        let currentAudio = null;
        let isPlaying = false;
        let isSearchResultsView = false;
        let currentPlaylistPage = 1;
        const SONGS_PER_PAGE = 10;
        
        // DOMå…ƒç´ 
        const chartsContainer = document.getElementById('charts-container');
        const songsContainer = document.getElementById('songs-container');
        const playlistContainer = document.getElementById('playlist-items');
        const playlistPagination = document.getElementById('playlist-pagination');
        const playlistCount = document.getElementById('playlist-count');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const clearBtn = document.getElementById('clear-btn');
        const shareBtn = document.getElementById('share-btn');
        const audioPlayer = document.getElementById('audio-player');
        const audioInfo = document.getElementById('audio-info');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        // åˆå§‹åŒ–ç‚¹æ­Œç³»ç»Ÿ
        function initKaraoke() {
            setupEventListeners();
            updatePlaylistCount();
            loadChart('chinese-pop');
        }
        
        // ä½¿ç”¨iTunes APIæœç´¢éŸ³ä¹
        async function searchMusic(term, category = 'musicTrack', limit = 100) {
            try {
                showLoading('æ­£åœ¨æœç´¢...');
                
                // ä½¿ç”¨ä»£ç†æˆ–ç›´æ¥è®¿é—®iTunes API
                const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=${category}&limit=${limit}&country=US`);
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (data.resultCount === 0) {
                    showError('æœªæ‰¾åˆ°ç›¸å…³ç»“æœ');
                    return [];
                }
                
                // å¤„ç†è¿”å›çš„æ•°æ®
                return data.results.map(track => ({
                    id: track.trackId || Math.random().toString(36).substr(2, 9),
                    title: track.trackName || 'æœªçŸ¥æ­Œæ›²',
                    artist: track.artistName || 'æœªçŸ¥æ­Œæ‰‹',
                    album: track.collectionName || 'æœªçŸ¥ä¸“è¾‘',
                    duration: track.trackTimeMillis,
                    previewUrl: track.previewUrl,
                    artwork: track.artworkUrl100
                }));
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                // å¦‚æœiTunes APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                return await searchMusicBackup(term, limit);
            }
        }
        
        // å¤‡ç”¨æœç´¢æ–¹æ¡ˆ
        async function searchMusicBackup(term, limit = 50) {
            try {
                // ä½¿ç”¨å…¶ä»–éŸ³ä¹APIæˆ–æ¨¡æ‹Ÿæ•°æ®
                const mockSongs = generateMockSongs(term, limit);
                return mockSongs;
            } catch (error) {
                console.error('å¤‡ç”¨æœç´¢å¤±è´¥:', error);
                showError('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
                return [];
            }
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿæ­Œæ›²æ•°æ®
        function generateMockSongs(query, limit) {
            const mockData = [
                { id: 1, title: 'å‘Šç™½æ°”çƒ', artist: 'å‘¨æ°ä¼¦', album: 'å‘¨æ°ä¼¦çš„åºŠè¾¹æ•…äº‹', duration: 215000, previewUrl: null },
                { id: 2, title: 'å…‰å¹´ä¹‹å¤–', artist: 'é‚“ç´«æ£‹', album: 'å…‰å¹´ä¹‹å¤–', duration: 235000, previewUrl: null },
                { id: 3, title: 'æ¼”å‘˜', artist: 'è–›ä¹‹è°¦', album: 'ç»…å£«', duration: 257000, previewUrl: null },
                { id: 4, title: 'å¹´å°‘æœ‰ä¸º', artist: 'æè£æµ©', album: 'è€³æœµ', duration: 244000, previewUrl: null },
                { id: 5, title: 'èµ·é£äº†', artist: 'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸', album: 'èµ·é£äº†', duration: 318000, previewUrl: null },
                { id: 6, title: 'ä½“é¢', artist: 'äºæ–‡æ–‡', album: 'ä½“é¢', duration: 287000, previewUrl: null },
                { id: 7, title: 'é£˜å‘åŒ—æ–¹', artist: 'é»„æ˜å¿—, ç‹åŠ›å®', album: 'äºšæ´²é€šè½¦', duration: 323000, previewUrl: null },
                { id: 8, title: 'è¯´æ•£å°±æ•£', artist: 'JC', album: 'è¯´æ•£å°±æ•£', duration: 258000, previewUrl: null },
                { id: 9, title: 'è¿½å…‰è€…', artist: 'å²‘å®å„¿', album: 'å¤è‡³æœªè‡³', duration: 236000, previewUrl: null },
                { id: 10, title: 'å²æœˆç¥å·', artist: 'é‡‘çŸå²', album: 'å²æœˆç¥å·', duration: 245000, previewUrl: null }
            ];
            
            // æ ¹æ®æŸ¥è¯¢è¯è¿‡æ»¤
            const filtered = mockData.filter(song => 
                song.title.toLowerCase().includes(query.toLowerCase()) ||
                song.artist.toLowerCase().includes(query.toLowerCase())
            );
            
            return filtered.slice(0, limit);
        }
        
        // åŠ è½½æ’è¡Œæ¦œ
        async function loadChart(category) {
            isSearchResultsView = false;
            let searchTerm = '';
            let entityType = 'musicTrack';
            let limit = 50;
            
            switch(category) {
                case 'chinese-pop':
                    searchTerm = 'popular chinese songs';
                    break;
                case 'western-pop':
                    searchTerm = 'pop music';
                    break;
                case 'chinese-dj':
                    searchTerm = 'chinese remix';
                    break;
                case 'chinese-artists':
                    // åªæ˜¾ç¤ºæ­Œæ‰‹åå­—
                    renderArtistsList([
                        'å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'è–›ä¹‹è°¦', 'æè£æµ©', 
                        'ç‹åŠ›å®', 'é™ˆå¥•è¿…', 'å¼ æƒ å¦¹', 'è”¡ä¾æ—', 'å­™ç‡•å§¿',
                        'äº”æœˆå¤©', 'å¼ å­¦å‹', 'åˆ˜å¾·å', 'ç‹è²', 'å¼ æ°',
                        'è®¸åµ©', 'æ±ªè‹æ³·', 'å¾ä½³è¹', 'æ¨å®—çº¬', 'è§æ•¬è…¾'
                    ]);
                    return;
                case 'western-artists':
                    // åªæ˜¾ç¤ºæ­Œæ‰‹åå­—
                    renderArtistsList([
                        'Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish',
                        'Drake', 'The Weeknd', 'Dua Lipa', 'Post Malone', 'Bruno Mars'
                    ]);
                    return;
            }
            
            currentSongs = await searchMusic(searchTerm, entityType, limit);
            renderSongs(currentSongs);
            
            // é«˜äº®é€‰ä¸­çš„æ’è¡Œæ¦œ
            document.querySelectorAll('.chart-category').forEach(chart => {
                chart.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
        }
        
        // æ¸²æŸ“æ­Œæ‰‹åˆ—è¡¨
        function renderArtistsList(artists) {
            songsContainer.innerHTML = '';
            
            artists.forEach(artist => {
                const artistElement = document.createElement('div');
                artistElement.className = 'song';
                artistElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${artist}</div>
                        <div class="song-artist">æ­Œæ‰‹</div>
                    </div>
                    <div class="song-controls">
                        <button class="add-btn" data-artist="${artist}">æœç´¢</button>
                    </div>
                `;
                songsContainer.appendChild(artistElement);
            });
        }
        
        // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆä¸¤åˆ—å¸ƒå±€ï¼‰
        function renderSongs(songs) {
            songsContainer.innerHTML = '';
            
            if (songs.length === 0) {
                songsContainer.innerHTML = '<div class="empty-playlist">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                return;
            }
            
            // å¦‚æœæ˜¯æœç´¢ç»“æœé¡µé¢ï¼Œæ·»åŠ è¿”å›æŒ‰é’®
            if (isSearchResultsView) {
                const backButton = document.createElement('button');
                backButton.className = 'back-btn';
                backButton.textContent = 'â† è¿”å›æ’è¡Œæ¦œ';
                backButton.addEventListener('click', () => {
                    isSearchResultsView = false;
                    loadChart('chinese-pop');
                });
                songsContainer.appendChild(backButton);
            }
            
            songs.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'song';
                songElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-album">${song.album}</div>
                    </div>
                    <div class="song-controls">
                        ${song.previewUrl ? `<button class="preview-btn" data-id="${song.id}" data-preview="${song.previewUrl}">â–¶ï¸</button>` : ''}
                        <button class="add-btn" data-id="${song.id}">+</button>
                    </div>
                `;
                songsContainer.appendChild(songElement);
            });
        }
        
        // æ¸²æŸ“æ­Œå•ï¼ˆå¸¦åˆ†é¡µåŠŸèƒ½ï¼‰
        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>';
                renderPlaylistPagination();
                return;
            }
            
            // è®¡ç®—å½“å‰é¡µçš„æ­Œæ›²
            const startIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
            const endIndex = Math.min(startIndex + SONGS_PER_PAGE, playlist.length);
            const currentSongs = playlist.slice(startIndex, endIndex);
            
            currentSongs.forEach((song, index) => {
                const globalIndex = startIndex + index;
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.draggable = true;
                playlistItem.dataset.index = globalIndex;
                playlistItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="song-number">${globalIndex + 1}</div>
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${globalIndex}">Ã—</button>
                `;
                playlistContainer.appendChild(playlistItem);
            });
            
            renderPlaylistPagination();
            setupDragAndDrop();
        }
        
        // æ¸²æŸ“æ­Œå•åˆ†é¡µ
        function renderPlaylistPagination() {
            playlistPagination.innerHTML = '';
            
            if (playlist.length <= SONGS_PER_PAGE) {
                return;
            }
            
            const totalPages = Math.ceil(playlist.length / SONGS_PER_PAGE);
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            if (currentPlaylistPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'ä¸Šä¸€é¡µ';
                prevButton.addEventListener('click', () => {
                    currentPlaylistPage--;
                    renderPlaylist();
                });
                playlistPagination.appendChild(prevButton);
            }
            
            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPlaylistPage);
                pageButton.addEventListener('click', () => {
                    currentPlaylistPage = i;
                    renderPlaylist();
                });
                playlistPagination.appendChild(pageButton);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            if (currentPlaylistPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                nextButton.addEventListener('click', () => {
                    currentPlaylistPage++;
                    renderPlaylist();
                });
                playlistPagination.appendChild(nextButton);
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ’è¡Œæ¦œç‚¹å‡»äº‹ä»¶
            chartsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('chart-category')) {
                    const category = e.target.dataset.category;
                    loadChart(category);
                }
            });
            
            // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
            songsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-btn')) {
                    const songId = e.target.dataset.id;
                    const artist = e.target.dataset.artist;
                    
                    if (artist) {
                        // ç‚¹å‡»çš„æ˜¯æ­Œæ‰‹æœç´¢æŒ‰é’®
                        performSearch(artist);
                    } else if (songId) {
                        // ç‚¹å‡»çš„æ˜¯æ·»åŠ æ­Œæ›²æŒ‰é’®
                        addSongToPlaylist(songId);
                    }
                } else if (e.target.classList.contains('preview-btn')) {
                    const songId = e.target.dataset.id;
                    const previewUrl = e.target.dataset.preview;
                    previewSong(songId, previewUrl);
                }
            });
            
            // ä»æ­Œå•ç§»é™¤æ­Œæ›²
            playlistContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    removeSongFromPlaylist(index);
                }
            });
            
            // æœç´¢åŠŸèƒ½
            searchBtn.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) {
                    performSearch(query);
                } else {
                    showMessage('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                }
            });
            
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    const query = searchInput.value.trim();
                    if (query) {
                        performSearch(query);
                    }
                }
            });
            
            // æ¸…ç©ºæ­Œå•
            clearBtn.addEventListener('click', clearPlaylist);
            
            // åˆ†äº«æ­Œå•
            shareBtn.addEventListener('click', sharePlaylist);
            
            // éŸ³é¢‘æ§åˆ¶
            playPauseBtn.addEventListener('click', togglePlayPause);
            stopBtn.addEventListener('click', stopAudio);
        }
        
        // æ‰§è¡Œæœç´¢
        async function performSearch(query) {
            isSearchResultsView = true;
            currentSongs = await searchMusic(query, 'musicTrack', 100);
            renderSongs(currentSongs);
        }
        
        // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
        function addSongToPlaylist(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song) {
                // æ£€æŸ¥æ˜¯å¦å·²åœ¨æ­Œå•ä¸­
                if (!playlist.some(s => s.id == songId)) {
                    playlist.push({...song});
                    // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    currentPlaylistPage = 1;
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage(`å·²æ·»åŠ  "${song.title}" åˆ°æ­Œå•`);
                    
                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨ä¿å­˜æ­Œå•
                    if (currentUser) {
                        saveUserPlaylist();
                    }
                } else {
                    showMessage(`"${song.title}" å·²åœ¨æ­Œå•ä¸­`);
                }
            } else {
                showMessage('æ‰¾ä¸åˆ°è¯¥æ­Œæ›²ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä»æ­Œå•ç§»é™¤æ­Œæ›²
        function removeSongFromPlaylist(index) {
            if (index >= 0 && index < playlist.length) {
                const songTitle = playlist[index].title;
                playlist.splice(index, 1);
                
                // å¦‚æœåˆ é™¤æ­Œæ›²åå½“å‰é¡µæ²¡æœ‰æ­Œæ›²äº†ï¼Œåˆ™å›åˆ°ä¸Šä¸€é¡µ
                const currentPageStartIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
                if (playlist.length <= currentPageStartIndex && currentPlaylistPage > 1) {
                    currentPlaylistPage--;
                }
                
                renderPlaylist();
                updatePlaylistCount();
                showMessage(`å·²ä»æ­Œå•ç§»é™¤ "${songTitle}"`);
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨ä¿å­˜æ­Œå•
                if (currentUser) {
                    saveUserPlaylist();
                }
            }
        }
        
        // ä¿å­˜ç”¨æˆ·æ­Œå•åˆ° Supabase
        async function saveUserPlaylist() {
            if (!currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('playlists')
                    .upsert({
                        user_id: currentUser,
                        songs: playlist,
                        song_count: playlist.length,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                    
                if (error) {
                    console.error('ä¿å­˜æ­Œå•å¤±è´¥:', error);
                    throw error;
                }
                
                console.log('âœ… æ­Œå•ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜æ­Œå•å¤±è´¥:', error);
                showMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // ä» Supabase åŠ è½½ç”¨æˆ·æ­Œå•
        async function loadUserPlaylist() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('playlists')
                    .select('songs, song_count')
                    .eq('user_id', currentUser)
                    .single();
                    
                if (error) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®°å½•ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼ˆæ–°ç”¨æˆ·ï¼‰
                    if (error.code === 'PGRST116') {
                        console.log('ç”¨æˆ·æš‚æ— æ­Œå•');
                        return;
                    }
                    throw error;
                }
                
                if (data && data.songs) {
                    playlist = data.songs;
                    // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    currentPlaylistPage = 1;
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage('å·²åŠ è½½æ‚¨çš„æ­Œå•');
                }
            } catch (error) {
                console.error('åŠ è½½æ­Œå•å¤±è´¥:', error);
                showMessage('åŠ è½½æ­Œå•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // è¯•å¬æ­Œæ›²
        function previewSong(songId, previewUrl) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song && previewUrl) {
                // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                try {
                    currentAudio = new Audio(previewUrl);
                    
                    currentAudio.play().then(() => {
                        isPlaying = true;
                        playPauseBtn.textContent = "â¸ï¸";
                        
                        // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                        audioPlayer.classList.remove('hidden');
                        audioInfo.textContent = `è¯•å¬: ${song.title} - ${song.artist}`;
                        
                        showMessage(`å¼€å§‹è¯•å¬ "${song.title}"`);
                    }).catch(error => {
                        console.error('æ’­æ”¾å¤±è´¥:', error);
                        showMessage('è¯•å¬æ’­æ”¾å¤±è´¥ï¼Œè¯¥æ­Œæ›²å¯èƒ½æ— æ³•åœ¨å½“å‰åœ°åŒºæ’­æ”¾');
                    });
                    
                    // éŸ³é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
                    currentAudio.addEventListener('ended', () => {
                        stopAudio();
                        showMessage(`è¯•å¬ç»“æŸ: ${song.title}`);
                    });
                    
                    // éŸ³é¢‘æ’­æ”¾é”™è¯¯äº‹ä»¶
                    currentAudio.addEventListener('error', (e) => {
                        console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                        stopAudio();
                        showMessage('è¯•å¬æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ­Œæ›²');
                    });
                    
                } catch (error) {
                    console.error('åˆ›å»ºéŸ³é¢‘å¤±è´¥:', error);
                    showMessage('è¯•å¬åŠŸèƒ½æš‚ä¸å¯ç”¨');
                }
            } else {
                showMessage('è¯¥æ­Œæ›²æš‚æ— è¯•å¬åŠŸèƒ½');
            }
        }
        
        // åˆ‡æ¢æ’­æ”¾/æš‚åœ
        function togglePlayPause() {
            if (currentAudio) {
                if (isPlaying) {
                    currentAudio.pause();
                    playPauseBtn.textContent = "â–¶ï¸";
                } else {
                    currentAudio.play().then(() => {
                        playPauseBtn.textContent = "â¸ï¸";
                    }).catch(error => {
                        console.error('æ’­æ”¾å¤±è´¥:', error);
                        showMessage('æ’­æ”¾å¤±è´¥');
                    });
                }
                isPlaying = !isPlaying;
            }
        }
        
        // åœæ­¢éŸ³é¢‘
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isPlaying = false;
                playPauseBtn.textContent = "â–¶ï¸";
                audioPlayer.classList.add('hidden');
            }
        }
        
        // æ¸…ç©ºæ­Œå•
        function clearPlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•å·²ç»æ˜¯ç©ºçš„');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿ')) {
                playlist = [];
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage('æ­Œå•å·²æ¸…ç©º');
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¿å­˜ç©ºæ­Œå•
                if (currentUser) {
                    saveUserPlaylist();
                }
            }
        }
        
        // åˆ†äº«æ­Œå• - è½¬è·³åˆ°è®¢å•é¡µé¢
        function sharePlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•æäº¤è®¢å•');
                return;
            }
            
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ä»¥ä¿å­˜å’Œæäº¤è®¢å•');
                loginModal.style.display = 'flex';
                return;
            }
            
            // è½¬è·³åˆ°è®¢å•é¡µé¢
            showOrderPage();
        }
        
        // æ˜¾ç¤ºè®¢å•é¡µé¢
        function showOrderPage() {
            showPage('order');
            setActiveNav(null);
            
            // å¡«å……ç”¨æˆ·ä¿¡æ¯
            const savedPhone = localStorage.getItem('userPhone');
            if (savedPhone) {
                document.getElementById('customer-phone').value = savedPhone;
            }
            
            // æ¸²æŸ“æ­Œå•é¢„è§ˆ
            renderOrderPlaylistPreview();
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºä»·æ ¼
            calculateAndDisplayPrice();
        }
        
        // æ¸²æŸ“è®¢å•é¡µé¢çš„æ­Œå•é¢„è§ˆ
        function renderOrderPlaylistPreview() {
            const previewContainer = document.getElementById('order-playlist-preview');
            previewContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                previewContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©º</div>';
                return;
            }
            
            // åªæ˜¾ç¤ºå‰10é¦–æ­Œæ›²ï¼Œå…¶ä½™çš„ç”¨çœç•¥å·è¡¨ç¤º
            const displaySongs = playlist.slice(0, 10);
            
            displaySongs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'playlist-preview-item';
                songElement.textContent = `${index + 1}. ${song.title} - ${song.artist}`;
                previewContainer.appendChild(songElement);
            });
            
            if (playlist.length > 10) {
                const moreElement = document.createElement('div');
                moreElement.className = 'playlist-preview-item';
                moreElement.textContent = `... è¿˜æœ‰ ${playlist.length - 10} é¦–æ­Œæ›²`;
                moreElement.style.fontStyle = 'italic';
                previewContainer.appendChild(moreElement);
            }
            
            const countElement = document.createElement('div');
            countElement.className = 'playlist-preview-item';
            countElement.textContent = `å…±è®¡ ${playlist.length} é¦–æ­Œæ›²`;
            countElement.style.fontWeight = 'bold';
            countElement.style.borderTop = '1px solid rgba(255,255,255,0.2)';
            countElement.style.paddingTop = '10px';
            countElement.style.marginTop = '10px';
            previewContainer.appendChild(countElement);
        }
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºä»·æ ¼
        function calculateAndDisplayPrice() {
            const songCount = playlist.length;
            const state = document.getElementById('customer-state').value;
            
            // æ ¹æ®æ­Œæ›²æ•°é‡ç¡®å®šé…å¥—
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ";
                packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ";
                packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ";
                packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ";
                packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ";
                packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ";
                packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ";
                packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ";
                packagePrice = songCount * 0.3;
            }
            
            // è®¡ç®—é‚®è´¹
            let shippingFee = 0;
            if (state === 'east') {
                shippingFee = 8;
            }
            
            const totalPrice = packagePrice + shippingFee;
            
            // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
            const priceSummary = document.getElementById('price-summary');
            priceSummary.innerHTML = `
                <div class="price-row">
                    <span>æ¨èé…å¥—ï¼š</span>
                    <span>${packageName} (${songCount}é¦–)</span>
                </div>
                <div class="price-row">
                    <span>é…å¥—ä»·æ ¼ï¼š</span>
                    <span>RM${packagePrice.toFixed(2)}</span>
                </div>
                <div class="price-row">
                    <span>é‚®è´¹ï¼š</span>
                    <span>${shippingFee === 0 ? 'å…è´¹' : `RM${shippingFee.toFixed(2)}`}</span>
                </div>
                <div class="price-row total-price">
                    <span>æ€»è´¹ç”¨ï¼š</span>
                    <span>RM${totalPrice.toFixed(2)}</span>
                </div>
            `;
        }
        
        // è®¾ç½®æ‹–æ‹½æ’åº
        function setupDragAndDrop() {
            const items = playlistContainer.querySelectorAll('.playlist-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
            
            playlistContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(playlistContainer, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable && afterElement) {
                    playlistContainer.insertBefore(draggable, afterElement);
                } else if (draggable) {
                    playlistContainer.appendChild(draggable);
                }
            });
            
            playlistContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const items = Array.from(playlistContainer.querySelectorAll('.playlist-item'));
                const toIndex = items.findIndex(item => item.classList.contains('dragging'));
                
                if (fromIndex !== toIndex && toIndex !== -1) {
                    // é‡æ–°æ’åºplaylistæ•°ç»„
                    const [movedItem] = playlist.splice(fromIndex, 1);
                    playlist.splice(toIndex, 0, movedItem);
                    
                    // æ›´æ–°UI
                    renderPlaylist();
                    showMessage('æ­Œå•é¡ºåºå·²æ›´æ–°');
                    
                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨ä¿å­˜æ­Œå•
                    if (currentUser) {
                        saveUserPlaylist();
                    }
                }
            });
        }
        
        // è·å–æ‹–æ‹½åçš„å…ƒç´ ä½ç½®
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // æ›´æ–°æ­Œå•è®¡æ•°
        function updatePlaylistCount() {
            playlistCount.textContent = `(${playlist.length})`;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message) {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                z-index: 1000;
                transition: all 0.3s;
            `;
            
            document.body.appendChild(messageEl);
            
            // 3ç§’åç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message) {
            songsContainer.innerHTML = `<div class="loading">${message}</div>`;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            songsContainer.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // ==================== è®¢å•åŠŸèƒ½ ====================
        document.getElementById('customer-state').addEventListener('change', calculateAndDisplayPrice);
        
        document.getElementById('cancel-order').addEventListener('click', function() {
            showPage('karaoke');
            setActiveNav(document.getElementById('karaoke-nav'));
        });
        
        document.getElementById('submit-order').addEventListener('click', function() {
            // éªŒè¯è¡¨å•
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            const state = document.getElementById('customer-state').value;
            
            if (!name || !phone || !address || !state) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            // é©¬æ¥è¥¿äºšç”µè¯å·ç éªŒè¯
            const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
            if (!malaysiaPhoneRegex.test(phone)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
                return;
            }
            
            // åˆ›å»ºè®¢å•
            createOrder(name, phone, address, state);
        });
        
        // åˆ›å»ºè®¢å•
        async function createOrder(name, phone, address, state) {
            const songCount = playlist.length;
            
            if (songCount === 0) {
                alert('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºè®¢å•');
                return;
            }
            
            // æ ¹æ®æ­Œæ›²æ•°é‡ç¡®å®šé…å¥—
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ";
                packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ";
                packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ";
                packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ";
                packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ";
                packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ";
                packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ";
                packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ";
                packagePrice = songCount * 0.3;
            }
            
            // è®¡ç®—é‚®è´¹
            let shippingFee = 0;
            if (state === 'east') {
                shippingFee = 8;
            }
            
            const totalPrice = packagePrice + shippingFee;
            
            // ç”Ÿæˆè®¢å•ç¼–å·
            const orderNumber = 'KTV' + Date.now();
            
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .insert({
                        order_number: orderNumber,
                        user_id: currentUser,
                        customer_name: name,
                        customer_phone: phone,
                        customer_address: address,
                        state: state,
                        songs: playlist,
                        song_count: songCount,
                        package_name: packageName,
                        package_price: packagePrice,
                        shipping_fee: shippingFee,
                        total_price: totalPrice,
                        status: 'pending',
                        notes: 'åœ¨çº¿è®¢å•'
                    })
                    .select();
                    
                if (error) {
                    console.error('è®¢å•åˆ›å»ºå¤±è´¥:', error);
                    throw error;
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`ğŸ‰ è®¢å•æäº¤æˆåŠŸï¼\n\nè®¢å•ç¼–å·: ${orderNumber}\né…å¥—: ${packageName}\næ­Œæ›²æ•°é‡: ${songCount} é¦–\næ€»è´¹ç”¨: RM${totalPrice.toFixed(2)}\n\næˆ‘ä»¬çš„å®¢æœå°†åœ¨24å°æ—¶å†…è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…ã€‚`);
                
                // æ¸…ç©ºå½“å‰æ­Œå•
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„æ­Œå•
                await saveUserPlaylist();
                
                // è¿”å›ç‚¹æ­Œé¡µé¢
                showPage('karaoke');
                setActiveNav(document.getElementById('karaoke-nav'));
                
            } catch (error) {
                console.error('è®¢å•æäº¤å¤±è´¥:', error);
                showMessage('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
            }
        }
        
        // ==================== è®¢å•ç®¡ç†åŠŸèƒ½ ====================
        document.getElementById('refresh-orders').addEventListener('click', loadOrders);
        
        // åŠ è½½è®¢å•åˆ—è¡¨
        async function loadOrders() {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                renderOrders(orders);
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                showMessage('åŠ è½½è®¢å•å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“è®¢å•åˆ—è¡¨
        function renderOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';
            
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">æš‚æ— è®¢å•</td></tr>';
                return;
            }
            
            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${order.order_number}</td>
                    <td>${order.customer_name}</td>
                    <td>${order.customer_phone}</td>
                    <td>${order.song_count}</td>
                    <td>${order.package_name}</td>
                    <td>RM${order.total_price}</td>
                    <td class="status-${order.status}">${getStatusText(order.status)}</td>
                    <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="view-order" data-id="${order.id}">æŸ¥çœ‹</button>
                        <button class="update-status" data-id="${order.id}">æ›´æ–°çŠ¶æ€</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // æ·»åŠ æŸ¥çœ‹è®¢å•äº‹ä»¶
            document.querySelectorAll('.view-order').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    viewOrderDetails(orderId);
                });
            });
            
            // æ·»åŠ æ›´æ–°çŠ¶æ€äº‹ä»¶
            document.querySelectorAll('.update-status').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.id;
                    updateOrderStatus(orderId);
                });
            });
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…ç¡®è®¤',
                'confirmed': 'å·²ç¡®è®¤', 
                'completed': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }
        
        // æŸ¥çœ‹è®¢å•è¯¦æƒ…
        async function viewOrderDetails(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();
                    
                if (error) throw error;
                
                let songsList = '';
                if (order.songs && order.songs.length > 0) {
                    songsList = order.songs.map((song, index) => 
                        `${index + 1}. ${song.title} - ${song.artist}`
                    ).join('\n');
                }
                
                alert(`è®¢å•è¯¦æƒ…ï¼š
è®¢å•ç¼–å·: ${order.order_number}
å®¢æˆ·å§“å: ${order.customer_name}
ç”µè¯å·ç : ${order.customer_phone}
æ”¶è´§åœ°å€: ${order.customer_address}
å·å±: ${order.state === 'west' ? 'è¥¿é©¬' : 'ä¸œé©¬'}
é…å¥—: ${order.package_name}
æ­Œæ›²æ•°é‡: ${order.song_count}
æ€»è´¹ç”¨: RM${order.total_price}
çŠ¶æ€: ${getStatusText(order.status)}
ä¸‹å•æ—¶é—´: ${new Date(order.created_at).toLocaleString()}

æ­Œæ›²åˆ—è¡¨:
${songsList || 'æ— æ­Œæ›²ä¿¡æ¯'}`);
            } catch (error) {
                console.error('æŸ¥çœ‹è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                showMessage('æŸ¥çœ‹è®¢å•è¯¦æƒ…å¤±è´¥');
            }
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        async function updateOrderStatus(orderId) {
            const newStatus = prompt('è¯·è¾“å…¥æ–°çš„è®¢å•çŠ¶æ€ (pending-å¾…ç¡®è®¤, confirmed-å·²ç¡®è®¤, completed-å·²å®Œæˆ):');
            
            if (newStatus && ['pending', 'confirmed', 'completed'].includes(newStatus)) {
                try {
                    const { error } = await supabase
                        .from('orders')
                        .update({ status: newStatus })
                        .eq('id', orderId);
                        
                    if (error) throw error;
                    
                    showMessage('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
                    loadOrders(); // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                } catch (error) {
                    console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                    showMessage('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥');
                }
            } else if (newStatus) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„çŠ¶æ€: pending, confirmed æˆ– completed');
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            initKaraoke();
            checkUserLogin();
            testConnection();
        });
    </script>
</body>
</html>